<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDC - ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1 {
            color: #FBBC04;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }

        select, textarea, input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .milestone-option {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .milestone-option:hover {
            border-color: #4285F4;
            background: #f8f9fa;
        }

        .milestone-option.selected {
            border-color: #34A853;
            background: #e8f5e9;
        }

        .photo-upload {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
        }

        .photo-preview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .photo-preview img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-primary {
            background: #FBBC04;
            color: white;
        }

        .btn-secondary {
            background: #f1f3f4;
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîî ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</h1>

        <div id="content">
            <div class="form-group">
                <label>Job ID</label>
                <input type="text" id="jobId" value="PDC-202510-0001" readonly>
            </div>

            <div class="form-group">
                <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô (Milestone)</label>
                <select id="milestone">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --</option>
                    <option value="Received">‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</option>
                    <option value="Inspection">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</option>
                    <option value="Disassembly">‡∏ñ‡∏≠‡∏î‡πÅ‡∏¢‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô</option>
                    <option value="Burnout">‡πÄ‡∏ú‡∏≤‡∏Ç‡∏î‡∏•‡∏ß‡∏î</option>
                    <option value="Core">‡∏ó‡∏≥ Core</option>
                    <option value="Rewinding">‡∏û‡∏±‡∏ô‡∏Ç‡∏î‡∏•‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà</option>
                    <option value="Varnish">‡πÄ‡∏Ñ‡∏•‡∏∑‡∏≠‡∏ö Varnish</option>
                    <option value="Assembly">‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</option>
                    <option value="Balancing">‡∏ñ‡πà‡∏ß‡∏á‡πÅ‡∏ö‡∏•‡∏≤‡∏ô‡∏ã‡πå</option>
                    <option value="Painting">‡∏û‡πà‡∏ô‡∏™‡∏µ</option>
                    <option value="QC">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û</option>
                    <option value="Final_Test">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</option>
                    <option value="Packing">‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏´‡∏µ‡∏ö‡∏´‡πà‡∏≠</option>
                    <option value="Delivery">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö</option>
                </select>
            </div>

            <div class="form-group">
                <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                <textarea id="note" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
            </div>

            <div class="form-group">
                <label>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏£‡∏π‡∏õ)</label>
                <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                    üì∑ ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ
                </div>
                <input type="file" id="photoInput" accept="image/*" multiple style="display: none;" 
                       onchange="handlePhotos(this.files)">
                <div class="photo-preview" id="photoPreview"></div>
            </div>

            <button class="btn btn-primary" onclick="updateStatus()">
                ‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            </button>

            <button class="btn btn-secondary" onclick="liff.closeWindow()">
                ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
        </div>
    </div>

    <script>
        let selectedPhotos = [];

        // Initialize LIFF
        window.onload = function() {
            liff.init({
                liffId: 'YOUR_LIFF_ID_HERE'
            }).then(() => {
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    // Load job_id from URL if available
                    const urlParams = new URLSearchParams(window.location.search);
                    const jobId = urlParams.get('job_id');
                    if (jobId) {
                        document.getElementById('jobId').value = jobId;
                    }
                }
            }).catch((err) => {
                alert('Error initializing LIFF: ' + err.message);
            });
        };

        // Handle photo selection
        function handlePhotos(files) {
            if (files.length > 3) {
                alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏£‡∏π‡∏õ');
                return;
            }

            selectedPhotos = [];
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';

            Array.from(files).slice(0, 3).forEach((file, index) => {
                const reader = new FileReader();

                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    preview.appendChild(img);

                    selectedPhotos.push({
                        name: file.name,
                        data: e.target.result.split(',')[1],  // Base64 data
                        type: file.type
                    });
                };

                reader.readAsDataURL(file);
            });
        }

        // Update status
        async function updateStatus() {
            const jobId = document.getElementById('jobId').value;
            const milestone = document.getElementById('milestone').value;
            const note = document.getElementById('note').value;

            if (!milestone) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞');
                return;
            }

            try {
                // Get user profile
                const profile = await liff.getProfile();

                // Call Web App to update status
                const response = await fetch('YOUR_WEB_APP_URL?action=update_status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        job_id: jobId,
                        milestone: milestone,
                        note: note,
                        photos: selectedPhotos,
                        actor_name: profile.displayName,
                        actor_id: profile.userId
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to update status');
                }

                const result = await response.json();

                // Send success message and close
                liff.sendMessages([{
                    type: 'text',
                    text: '‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n' +
                          'Job ID: ' + jobId + '\n' +
                          '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà: ' + getMilestoneText(milestone)
                }]).then(() => {
                    liff.closeWindow();
                });

            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Get milestone display text
        function getMilestoneText(milestone) {
            const map = {
                'Received': '‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô',
                'Inspection': '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô',
                'Disassembly': '‡∏ñ‡∏≠‡∏î‡πÅ‡∏¢‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô',
                'Burnout': '‡πÄ‡∏ú‡∏≤‡∏Ç‡∏î‡∏•‡∏ß‡∏î',
                'Core': '‡∏ó‡∏≥ Core',
                'Rewinding': '‡∏û‡∏±‡∏ô‡∏Ç‡∏î‡∏•‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà',
                'Varnish': '‡πÄ‡∏Ñ‡∏•‡∏∑‡∏≠‡∏ö Varnish',
                'Assembly': '‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö',
                'Balancing': '‡∏ñ‡πà‡∏ß‡∏á‡πÅ‡∏ö‡∏•‡∏≤‡∏ô‡∏ã‡πå',
                'Painting': '‡∏û‡πà‡∏ô‡∏™‡∏µ',
                'QC': '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û',
                'Final_Test': '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏ü‡πâ‡∏≤',
                'Packing': '‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏´‡∏µ‡∏ö‡∏´‡πà‡∏≠',
                'Delivery': '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö'
            };
            return map[milestone] || milestone;
        }
    </script>
</body>
</html>
